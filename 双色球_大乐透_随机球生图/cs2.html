<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>彩票选号生成器 - 增强版</title>
<style>
    :root {
        --red-ball-color: #e91e63;
        --blue-ball-color: #2196f3;
        --red-text-color: #fff;
        --blue-text-color: #fff;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft YaHei',sans-serif}
    body{background:linear-gradient(to bottom,#f0f8ff,#e1f5fe);min-height:100vh;padding:20px;color:#333}
    .container{max-width:1280px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 0 20px rgba(0,0,0,.1);overflow:hidden;display:flex;flex-direction:column}
    header{background:linear-gradient(to right,#ff5252,#ff4081);color:#fff;padding:20px;text-align:center}
    h1{font-size:28px;margin-bottom:10px;text-shadow:1px 1px 3px rgba(0,0,0,.3)}
    .subtitle{font-size:16px;opacity:.9}

    /* 主内容区布局 */
    .main-content {display: flex; flex-direction: column; flex: 1;}
    .content-row {display: flex; flex: 1;}

    /* 左侧彩票区 */
    .lottery-area {flex: 1; display: flex; flex-direction: column;}
    .tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e0e0e0}
    .tab{flex:1;padding:15px;text-align:center;font-size:18px;font-weight:bold;cursor:pointer;transition:.3s;border-bottom:3px solid transparent}
    .tab.active{background:#fff;color:#e91e63;border-bottom:3px solid #e91e63}
    .lottery-content{display:none;padding:20px;position:relative}
    .lottery-content.active{display:block}
    .section-title{text-align:center;margin:15px 0;color:#e91e63;font-size:20px;font-weight:bold}
    .section-label{text-align:center;margin-bottom:15px;font-size:16px;color:#555}
    .balls-container{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-bottom:20px}
    .ball{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:16px;cursor:pointer;transition:.2s;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .red-ball{background:#fff;color:var(--red-ball-color);border:2px solid var(--red-ball-color)}
    .red-ball.selected{background:var(--red-ball-color);color:var(--red-text-color)}
    .blue-ball{background:#fff;color:var(--blue-ball-color);border:2px solid var(--blue-ball-color)}
    .blue-ball.selected{background:var(--blue-ball-color);color:var(--blue-text-color)}
    .selected-numbers{text-align:center;padding:15px;background:#f5f5f5;border-radius:10px;margin:20px 0;font-size:18px;font-weight:bold}
    .red-number{color:var(--red-ball-color);margin:0 3px}.blue-number{color:var(--blue-ball-color);margin:0 3px}.separator{color:#777;margin:0 5px}
    footer{text-align:center;padding:20px;color:#777;font-size:14px;background:#f8f9fa;border-top:1px solid #e0e0e0}

    /* 截图控制区 */
    .capture-control-section {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
    }
    .capture-control {padding: 15px;background: #fff;border-radius: 10px;box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
    .capture-control h3 {color: #e91e63;margin-top: 0;margin-bottom: 15px;text-align: center;}
    .capture-control-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 15px;
    }
    .capture-control-row {display: flex;align-items: center; gap: 8px;}
    .capture-label {font-weight: bold;color: #333; min-width: 60px;}
    .capture-input {width: 100%;padding: 8px;border: 1px solid #ddd;border-radius: 4px;text-align: center;}
    .capture-reset-btn {padding: 10px;background: #9c27b0;color: white;border: none;border-radius: 5px;cursor: pointer;font-weight: bold;width: 100%;}
    .capture-reset-btn:hover {background: #7b1fa2;}
    .preview-btn {width: 100%;padding: 10px;background: #2196f3;color: white;border: none;border-radius: 5px;cursor: pointer;font-weight: bold;}
    .preview-btn:hover {background: #0d8bf2;}
    .dimension-display {text-align: center;padding: 5px;margin-top: 8px;background: #f0f0f0;border-radius: 4px;font-size: 14px;}

    /* 右侧控制面板 */
    .control-panel {width: 320px;padding: 20px;background: #f5f5f5;border-left: 1px solid #e0e0e0; display: flex; flex-direction: column;}
    .panel-section {margin-bottom: 20px;}
    .panel-section-title {font-size: 18px; color: #e91e63; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0;}

    /* 控制按钮 */
    .control-buttons {display: flex; flex-direction: column; gap: 12px;}
    .btn{padding:12px;border:none;border-radius:5px;font-size:16px;font-weight:bold;cursor:pointer;transition:.3s;box-shadow:0 3px 5px rgba(0,0,0,.2)}
    .btn-generate{background:#4caf50;color:#fff}.btn-generate:hover{background:#388e3c}
    .btn-reset{background:#f44336;color:#fff}.btn-reset:hover{background:#d32f2f}
    .btn-stop{background:#ff5722;color:#fff}.btn-stop:hover{background:#e64a19}

    /* 颜色选择器 */
    .color-picker-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .color-control{display:flex;flex-direction: column; gap:6px;}
    .color-label{font-weight:bold; font-size: 14px;}
    .color-input-container {display: flex; align-items: center; gap: 10px;}
    .color-input{width:40px;height:40px;border:none;cursor:pointer;border-radius:5px}
    .apply-colors-btn {padding:10px;background:#9c27b0;color:#fff;border:none;border-radius:5px;font-weight:bold;cursor:pointer;grid-column: span 2;margin-top: 10px;}
    .apply-colors-btn:hover{background:#7b1fa2}

    /* 背景设置 */
    .bg-preview{width:100%;height:100px;border-radius:10px;margin-top:10px;background-size:cover;background-position:center;border:1px solid #ddd}
    .bg-actions{display:flex;gap:10px;margin-top:10px}
    .bg-btn{padding:8px 15px;border:none;border-radius:5px;cursor:pointer;font-size:14px}
    .bg-select{background:#2196f3;color:#fff}
    .bg-reset{background:#9e9e9e;color:#fff}
    .bg-select:hover{background:#0d8bf2}
    .bg-reset:hover{background:#757575}

    /* 批量控制 */
    .batch-control{display:flex;flex-direction:column;gap:10px}
    .batch-control-row{display:flex;align-items:center;gap:10px}
    .batch-control label{font-weight:bold;min-width:100px}
    .batch-control input{width:80px;padding:8px;border:2px solid #ddd;border-radius:5px;text-align:center}
    .path-selector{display:flex;align-items:center;gap:10px}
    .path-display{padding:8px 15px;background:#fff;border:1px solid #ddd;border-radius:5px;min-width:100px;text-align:left;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
    .select-path-btn{padding:8px 15px;background:#2196f3;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:14px}
    .select-path-btn:hover{background:#0d8bf2}
    .download-btn{padding:12px;background:#9c27b0;color:#fff;border:none;border-radius:5px;font-size:16px;font-weight:bold;cursor:pointer;transition:.3s;box-shadow:0 3px 5px rgba(0,0,0,.2)}
    .download-btn:hover{background:#7b1fa2}
    .status-message{margin-top:15px;padding:10px;border-radius:5px;font-size:14px;text-align:center}
    .status-success{background:#e8f5e9;color:#2e7d32}.status-error{background:#ffebee;color:#c62828}

    /* 折叠面板 */
    .accordion {border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; overflow: hidden;}
    .accordion-header {padding: 12px 15px; background: #f8f9fa; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center;}
    .accordion-icon {transition: transform 0.3s;}
    .accordion-content {padding: 10px 15px; background: #fff; display: none;}
    .accordion.active .accordion-content {display: block;}
    .accordion.active .accordion-icon {transform: rotate(180deg);}

    /* 选择框 */
    .selection-box {position: absolute;border: 2px dashed #ff4081;background: rgba(255, 64, 129, 0.1);z-index: 100;cursor: move;}
    .selection-box:hover {border-color: #ff5252;}
    .resize-handle {position: absolute;width: 12px;height: 12px;background: #ff4081;border-radius: 50%;}
    .resize-nw {top: -6px;left: -6px;cursor: nw-resize;}
    .resize-ne {top: -6px;right: -6px;cursor: ne-resize;}
    .resize-sw {bottom: -6px;left: -6px;cursor: sw-resize;}
    .resize-se {bottom: -6px;right: -6px;cursor: se-resize;}
</style>
</head>
<body>
<div class="container" id="capture-root">
    <header>
        <h1>彩票选号生成器 - 专业版</h1>
        <p class="subtitle">随机生成双色球和大乐透号码 | 增强截图功能</p>
    </header>

    <div class="capture-control-section">
        <div class="capture-control">
            <h3>截图区域设置</h3>
            <div class="capture-control-grid">
                <div class="capture-control-row">
                    <span class="capture-label">X:</span>
                    <input type="number" class="capture-input" id="capture-x" min="0" value="0">
                </div>
                <div class="capture-control-row">
                    <span class="capture-label">Y:</span>
                    <input type="number" class="capture-input" id="capture-y" min="0" value="0">
                </div>
                <div class="capture-control-row">
                    <span class="capture-label">宽度:</span>
                    <input type="number" class="capture-input" id="capture-width" min="50" value="400">
                </div>
                <div class="capture-control-row">
                    <span class="capture-label">高度:</span>
                    <input type="number" class="capture-input" id="capture-height" min="50" value="200">
                </div>
            </div>
            <div class="dimension-display" id="dimension-display">400px × 200px</div>
            <button class="capture-reset-btn" id="capture-reset">重置截图区域</button>
            <button class="preview-btn" id="preview-capture">预览截图区域</button>
        </div>
    </div>

    <div class="content-row">
        <div class="lottery-area">
            <div class="tabs">
                <div class="tab active" data-target="ssq">双色球选号器</div>
                <div class="tab" data-target="dlt">大乐透选号器</div>
            </div>

            <!-- 双色球 -->
            <section class="lottery-content active" id="ssq-content">
                <div class="section-title">双色球选号器</div>
                <div class="section-label">红球区（选择6个）</div>
                <div class="balls-container" id="ssq-red-balls"></div>
                <div class="section-label">蓝球区（选择1个）</div>
                <div class="balls-container" id="ssq-blue-balls"></div>

                <div class="selected-numbers" id="ssq-selected">
                    选中的号码：<span class="red-number">2</span> <span class="red-number">8</span> <span class="red-number">13</span> <span class="red-number">16</span> <span class="red-number">21</span> <span class="red-number">23</span> <span class="separator">→</span> <span class="blue-number">12</span>
                </div>
            </section>

            <!-- 大乐透 -->
            <section class="lottery-content" id="dlt-content">
                <div class="section-title">大乐透选号器</div>

                <div class="section-label">前区红球（选择5个）</div>
                <div class="balls-container" id="dlt-red-balls"></div>

                <div class="section-label">后区蓝球（选择2个）</div>
                <div class="balls-container" id="dlt-blue-balls"></div>

                <div class="selected-numbers" id="dlt-selected">
                    选中的号码：<span class="red-number">3</span> <span class="red-number">11</span> <span class="red-number">13</span> <span class="red-number">22</span> <span class="red-number">31</span> <span class="blue-number">2</span> <span class="blue-number">8</span>
                </div>
            </section>

            <footer>
                <p>© 2023 彩票选号生成器 | 本工具仅供娱乐参考 | 截图区域可自由调整</p>
            </footer>
        </div>

        <div class="control-panel">
            <div class="panel-section">
                <div class="panel-section-title">操作控制</div>
                <div class="control-buttons">
                    <button class="btn btn-generate" id="ssq-generate">开始选号</button>
                    <button class="btn btn-stop" id="ssq-stop">停止</button>
                    <button class="btn btn-reset" id="ssq-reset">重置双色球</button>

                    <button class="btn btn-generate" id="dlt-generate">开始选号</button>
                    <button class="btn btn-stop" id="dlt-stop">停止</button>
                    <button class="btn btn-reset" id="dlt-reset">重置大乐透</button>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-section-title">颜色设置</div>
                <div class="color-picker-grid">
                    <div class="color-control">
                        <span class="color-label">红球颜色</span>
                        <div class="color-input-container">
                            <input type="color" class="color-input" id="red-ball-color" value="#e91e63">
                            <span>背景</span>
                        </div>
                    </div>
                    <div class="color-control">
                        <span class="color-label">红球文字</span>
                        <div class="color-input-container">
                            <input type="color" class="color-input" id="red-text-color" value="#ffffff">
                            <span>文字</span>
                        </div>
                    </div>
                    <div class="color-control">
                        <span class="color-label">蓝球颜色</span>
                        <div class="color-input-container">
                            <input type="color" class="color-input" id="blue-ball-color" value="#2196f3">
                            <span>背景</span>
                        </div>
                    </div>
                    <div class="color-control">
                        <span class="color-label">蓝球文字</span>
                        <div class="color-input-container">
                            <input type="color" class="color-input" id="blue-text-color" value="#ffffff">
                            <span>文字</span>
                        </div>
                    </div>
                    <button class="apply-colors-btn" id="apply-colors">应用颜色</button>
                </div>
            </div>

            <div class="accordion active">
                <div class="accordion-header">背景设置
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="bg-preview" id="bg-preview"></div>
                    <div class="bg-actions">
                        <button class="bg-btn bg-select" id="select-bg">选择背景图</button>
                        <button class="bg-btn bg-reset" id="reset-bg">恢复默认</button>
                    </div>
                    <input type="file" id="bg-file" accept="image/*" style="display:none">
                </div>
            </div>

            <div class="accordion active">
                <div class="accordion-header">批量生成设置
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="batch-control">
                        <div class="panel-section-title" style="margin-top: 0;">双色球</div>
                        <div class="batch-control-row">
                            <label>生成图片数量:</label>
                            <input type="number" id="ssq-count" min="1" max="100" value="5">
                        </div>
                        <div class="path-selector">
                            <div class="path-display" id="ssq-path-display">未选择保存路径</div>
                            <button class="select-path-btn" id="ssq-select-path">选择路径</button>
                        </div>
                        <button class="download-btn" id="ssq-download">生成双色球图片</button>
                        <div class="status-message" id="ssq-status"></div>
                    </div>

                    <div class="batch-control" style="margin-top: 15px;">
                        <div class="panel-section-title" style="margin-top: 0;">大乐透</div>
                        <div class="batch-control-row">
                            <label>生成图片数量:</label>
                            <input type="number" id="dlt-count" min="1" max="100" value="5">
                        </div>
                        <div class="path-selector">
                            <div class="path-display" id="dlt-path-display">未选择保存路径</div>
                            <button class="select-path-btn" id="dlt-select-path">选择路径</button>
                        </div>
                        <button class="download-btn" id="dlt-download">生成大乐透图片</button>
                        <div class="status-message" id="dlt-status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// -------------------- 初始化 --------------------
document.addEventListener('DOMContentLoaded', () => {
    initBalls('ssq-red-balls', 33, 'red');
    initBalls('ssq-blue-balls', 16, 'blue');
    initBalls('dlt-red-balls', 35, 'red');
    initBalls('dlt-blue-balls', 12, 'blue');
    setDefaultSelection();
    setupTabs();
    setupPathSelectors();
    setupButtonEvents();
    setupColorPicker();
    setupBackgroundControl();
    setupCaptureControl();
    setupAccordions();
});

// -------------------- 全局状态 --------------------
let dirHandleSSQ = null;
let dirHandleDLT = null;
const timers = { ssq: null, dlt: null };
const lastPick = { ssq: { red: [], blue: [] }, dlt: { red: [], blue: [] } };
let selectionBox = null;
let currentLottery = 'ssq'; // 当前选中的彩票类型

// -------------------- UI --------------------
function initBalls(containerId, count, type){
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    for(let i=1;i<=count;i++){
        const el = document.createElement('div');
        el.className = `ball ${type}-ball`;
        el.textContent = i;
        el.dataset.number = i;
        el.addEventListener('click', function(){
            this.classList.toggle('selected');
            updateSelectedNumbers();
        });
        container.appendChild(el);
    }
}

function setDefaultSelection(){
    selectBalls('ssq-red-balls', [2,8,13,16,21,23]);
    selectBalls('ssq-blue-balls', [12]);
    selectBalls('dlt-red-balls', [3,11,13,22,31]);
    selectBalls('dlt-blue-balls', [2,8]);
}

function selectBalls(containerId, numbers){
    const container = document.getElementById(containerId);
    const balls = container.querySelectorAll('.ball');
    balls.forEach(b=>{
        const n = +b.dataset.number;
        if(numbers.includes(n)) b.classList.add('selected');
    });
    updateSelectedNumbers();
}

function resetSelection(containerId){
    const container = document.getElementById(containerId);
    container.querySelectorAll('.ball.selected').forEach(b=>b.classList.remove('selected'));
}

function updateSelectedNumbers(){
    const ssqR = getSelected('#ssq-red-balls');
    const ssqB = getSelected('#ssq-blue-balls');
    document.getElementById('ssq-selected').innerHTML =
        `选中的号码：${ssqR.map(n=>`<span class="red-number">${n}</span>`).join(' ')} <span class="separator">→</span> ${ssqB.map(n=>`<span class="blue-number">${n}</span>`).join(' ')}`;

    const dltR = getSelected('#dlt-red-balls');
    const dltB = getSelected('#dlt-blue-balls');
    document.getElementById('dlt-selected').innerHTML =
        `选中的号码：${dltR.map(n=>`<span class="red-number">${n}</span>`).join(' ')} ${dltB.map(n=>`<span class="blue-number">${n}</span>`).join(' ')}`;

    lastPick.ssq = { red: ssqR, blue: ssqB };
    lastPick.dlt = { red: dltR,  blue: dltB  };
}

function getSelected(selector){
    return Array.from(document.querySelectorAll(`${selector} .ball.selected`))
      .map(b=>+b.dataset.number).sort((a,b)=>a-b);
}

// -------------------- 随机选号 --------------------
function randomPick(count, max){
    const set = new Set();
    while(set.size < count) set.add(Math.floor(Math.random()*max)+1);
    return [...set].sort((a,b)=>a-b);
}

function applyPick(prefix, redNums, blueNums){
    resetSelection(`${prefix}-red-balls`);
    resetSelection(`${prefix}-blue-balls`);

    const redEls = document.getElementById(`${prefix}-red-balls`).querySelectorAll('.ball');
    redNums.forEach(n=>redEls[n-1]?.classList.add('selected'));
    const blueEls = document.getElementById(`${prefix}-blue-balls`).querySelectorAll('.ball');
    blueNums.forEach(n=>blueEls[n-1]?.classList.add('selected'));

    updateSelectedNumbers();
}

function startRolling(prefix){
    stopRolling(prefix);
    const cfg = prefix==='ssq' ? {rMax:33, rCount:6, bMax:16, bCount:1} : {rMax:35, rCount:5, bMax:12, bCount:2};
    timers[prefix] = setInterval(()=>{
        const r = randomPick(cfg.rCount, cfg.rMax);
        const b = randomPick(cfg.bCount, cfg.bMax);
        applyPick(prefix, r, b);
    },120);
}

function stopRolling(prefix){
    if(timers[prefix]) { clearInterval(timers[prefix]); timers[prefix]=null; }
}

// -------------------- 选项卡 --------------------
function setupTabs(){
    document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click', function(){
            const target = this.dataset.target;
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.lottery-content').forEach(c=>c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(`${target}-content`).classList.add('active');
            currentLottery = target; // 更新当前彩票类型
            // 更新截图区域预览框位置
            updateSelectionBoxPosition();
        });
    });
}

// -------------------- 路径选择 --------------------
function setupPathSelectors(){
    document.getElementById('ssq-select-path').addEventListener('click', async ()=>{
        const handle = await pickDirectory();
        if(handle){ dirHandleSSQ = handle; document.getElementById('ssq-path-display').textContent = handle.name; }
    });
    document.getElementById('dlt-select-path').addEventListener('click', async ()=>{
        const handle = await pickDirectory();
        if(handle){ dirHandleDLT = handle; document.getElementById('dlt-path-display').textContent = handle.name; }
    });
}

async function pickDirectory(){
    if('showDirectoryPicker' in window){
        try{
            const dir = await window.showDirectoryPicker();
            const ok = await requestRW(dir);
            return ok ? dir : null;
        }catch(e){ console.warn(e); return null; }
    }else{ alert('当前浏览器不支持目录选择，将使用浏览器下载方式保存。'); return null; }
}
async function requestRW(handle){
    if(!handle || !handle.requestPermission) return true;
    const opts = { mode:'readwrite' };
    const cur = await handle.queryPermission?.(opts);
    if(cur === 'granted') return true;
    const res = await handle.requestPermission?.(opts);
    return res === 'granted';
}

// -------------------- 按钮事件 --------------------
function setupButtonEvents(){
    document.getElementById('ssq-generate').addEventListener('click', ()=>startRolling('ssq'));
    document.getElementById('ssq-stop').addEventListener('click', ()=>stopRolling('ssq'));
    document.getElementById('dlt-generate').addEventListener('click', ()=>startRolling('dlt'));
    document.getElementById('dlt-stop').addEventListener('click', ()=>stopRolling('dlt'));

    document.getElementById('ssq-reset').addEventListener('click', ()=>{
        resetSelection('ssq-red-balls');
        resetSelection('ssq-blue-balls');
        updateSelectedNumbers();
    });

    document.getElementById('dlt-reset').addEventListener('click', ()=>{
        resetSelection('dlt-red-balls');
        resetSelection('dlt-blue-balls');
        updateSelectedNumbers();
    });

    document.getElementById('ssq-download').addEventListener('click', async ()=>{
        const n = +document.getElementById('ssq-count').value || 1;
        await saveScreenshots('ssq','双色球', n, dirHandleSSQ);
    });
    document.getElementById('dlt-download').addEventListener('click', async ()=>{
        const n = +document.getElementById('dlt-count').value || 1;
        await saveScreenshots('dlt','大乐透', n, dirHandleDLT);
    });
}

// -------------------- 颜色选择器 --------------------
function setupColorPicker(){
    const redBallColorInput = document.getElementById('red-ball-color');
    const blueBallColorInput = document.getElementById('blue-ball-color');
    const redTextColorInput = document.getElementById('red-text-color');
    const blueTextColorInput = document.getElementById('blue-text-color');
    const applyButton = document.getElementById('apply-colors');

    // 设置初始值
    redBallColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--red-ball-color').trim();
    blueBallColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--blue-ball-color').trim();
    redTextColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--red-text-color').trim();
    blueTextColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--blue-text-color').trim();

    applyButton.addEventListener('click', () => {
        document.documentElement.style.setProperty('--red-ball-color', redBallColorInput.value);
        document.documentElement.style.setProperty('--blue-ball-color', blueBallColorInput.value);
        document.documentElement.style.setProperty('--red-text-color', redTextColorInput.value);
        document.documentElement.style.setProperty('--blue-text-color', blueTextColorInput.value);
    });
}

// -------------------- 背景控制 --------------------
function setupBackgroundControl(){
    const bgFileInput = document.getElementById('bg-file');
    const bgPreview = document.getElementById('bg-preview');
    const selectButton = document.getElementById('select-bg');
    const resetButton = document.getElementById('reset-bg');

    selectButton.addEventListener('click', () => {
        bgFileInput.click();
    });

    resetButton.addEventListener('click', () => {
        document.body.style.background = 'linear-gradient(to bottom,#f0f8ff,#e1f5fe)';
        bgPreview.style.background = '';
    });

    bgFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !file.type.match('image.*')) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const imageUrl = e.target.result;
            document.body.style.background = `url(${imageUrl}) center/cover fixed`;
            bgPreview.style.background = `url(${imageUrl}) center/cover`;
        };
        reader.readAsDataURL(file);
    });
}

// -------------------- 截图区域控制 --------------------
function setupCaptureControl() {
    // 创建选择框
    createSelectionBox();

    // 重置按钮
    document.getElementById('capture-reset').addEventListener('click', resetCaptureArea);

    // 预览按钮
    document.getElementById('preview-capture').addEventListener('click', previewCaptureArea);

    // 输入框变化时更新预览框
    ['capture-x', 'capture-y', 'capture-width', 'capture-height'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateSelectionBoxPosition);
    });
}

function createSelectionBox() {
    selectionBox = document.createElement('div');
    selectionBox.className = 'selection-box';
    selectionBox.style.display = 'none';

    // 创建调整大小的手柄
    const handles = ['nw', 'ne', 'sw', 'se'];
    handles.forEach(pos => {
        const handle = document.createElement('div');
        handle.className = `resize-handle resize-${pos}`;
        handle.dataset.pos = pos;
        selectionBox.appendChild(handle);
    });

    document.body.appendChild(selectionBox);

    // 添加拖拽事件
    let isDragging = false;
    let startX, startY;
    let startLeft, startTop;
    let currentHandle = null;

    selectionBox.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resize-handle')) {
            // 调整大小
            currentHandle = e.target.dataset.pos;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(selectionBox.style.left);
            startTop = parseInt(selectionBox.style.top);
            const startWidth = parseInt(selectionBox.style.width);
            const startHeight = parseInt(selectionBox.style.height);

            function resize(e) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                if (currentHandle === 'nw') {
                    selectionBox.style.left = (startLeft + dx) + 'px';
                    selectionBox.style.top = (startTop + dy) + 'px';
                    selectionBox.style.width = (startWidth - dx) + 'px';
                    selectionBox.style.height = (startHeight - dy) + 'px';
                } else if (currentHandle === 'ne') {
                    selectionBox.style.top = (startTop + dy) + 'px';
                    selectionBox.style.width = (startWidth + dx) + 'px';
                    selectionBox.style.height = (startHeight - dy) + 'px';
                } else if (currentHandle === 'sw') {
                    selectionBox.style.left = (startLeft + dx) + 'px';
                    selectionBox.style.width = (startWidth - dx) + 'px';
                    selectionBox.style.height = (startHeight + dy) + 'px';
                } else if (currentHandle === 'se') {
                    selectionBox.style.width = (startWidth + dx) + 'px';
                    selectionBox.style.height = (startHeight + dy) + 'px';
                }

                updateInputsFromBox();
            }

            function stopResize() {
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }

            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        } else {
            // 移动整个选择框
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(selectionBox.style.left);
            startTop = parseInt(selectionBox.style.top);

            function move(e) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                selectionBox.style.left = (startLeft + dx) + 'px';
                selectionBox.style.top = (startTop + dy) + 'px';
                updateInputsFromBox();
            }

            function stopMove() {
                document.removeEventListener('mousemove', move);
                document.removeEventListener('mouseup', stopMove);
                isDragging = false;
            }

            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', stopMove);
        }
    });
}

function previewCaptureArea() {
    const content = document.getElementById(`${currentLottery}-content`);
    const rect = content.getBoundingClientRect();

    const x = parseInt(document.getElementById('capture-x').value) || 0;
    const y = parseInt(document.getElementById('capture-y').value) || 0;
    const width = parseInt(document.getElementById('capture-width').value) || 400;
    const height = parseInt(document.getElementById('capture-height').value) || 200;

    // 确保选择框在可见区域内
    const maxX = rect.width - width;
    const maxY = rect.height - height;
    const clampedX = Math.max(0, Math.min(x, maxX));
    const clampedY = Math.max(0, Math.min(y, maxY));

    selectionBox.style.display = 'block';
    selectionBox.style.left = (rect.left + clampedX) + 'px';
    selectionBox.style.top = (rect.top + clampedY) + 'px';
    selectionBox.style.width = width + 'px';
    selectionBox.style.height = height + 'px';

    // 更新输入框的值
    document.getElementById('capture-x').value = clampedX;
    document.getElementById('capture-y').value = clampedY;
    document.getElementById('capture-width').value = width;
    document.getElementById('capture-height').value = height;
    document.getElementById('dimension-display').textContent = `${width}px × ${height}px`;
}

function updateSelectionBoxPosition() {
    if (!selectionBox || selectionBox.style.display !== 'block') return;

    const content = document.getElementById(`${currentLottery}-content`);
    const rect = content.getBoundingClientRect();

    const x = parseInt(document.getElementById('capture-x').value) || 0;
    const y = parseInt(document.getElementById('capture-y').value) || 0;
    const width = parseInt(document.getElementById('capture-width').value) || 400;
    const height = parseInt(document.getElementById('capture-height').value) || 200;

    // 确保选择框在可见区域内
    const maxX = rect.width - width;
    const maxY = rect.height - height;
    const clampedX = Math.max(0, Math.min(x, maxX));
    const clampedY = Math.max(0, Math.min(y, maxY));

    selectionBox.style.left = (rect.left + clampedX) + 'px';
    selectionBox.style.top = (rect.top + clampedY) + 'px';
    selectionBox.style.width = width + 'px';
    selectionBox.style.height = height + 'px';

    // 更新输入框的值
    document.getElementById('capture-x').value = clampedX;
    document.getElementById('capture-y').value = clampedY;
    document.getElementById('capture-width').value = width;
    document.getElementById('capture-height').value = height;
    document.getElementById('dimension-display').textContent = `${width}px × ${height}px`;
}

function updateInputsFromBox() {
    const content = document.getElementById(`${currentLottery}-content`);
    const contentRect = content.getBoundingClientRect();
    const boxRect = selectionBox.getBoundingClientRect();

    const x = boxRect.left - contentRect.left;
    const y = boxRect.top - contentRect.top;
    const width = boxRect.width;
    const height = boxRect.height;

    document.getElementById('capture-x').value = Math.max(0, Math.round(x));
    document.getElementById('capture-y').value = Math.max(0, Math.round(y));
    document.getElementById('capture-width').value = Math.max(50, Math.round(width));
    document.getElementById('capture-height').value = Math.max(50, Math.round(height));
    document.getElementById('dimension-display').textContent = `${Math.round(width)}px × ${Math.round(height)}px`;
}

function resetCaptureArea() {
    // 双色球默认区域
    if (currentLottery === 'ssq') {
        document.getElementById('capture-x').value = 0;
        document.getElementById('capture-y').value = 0;
        document.getElementById('capture-width').value = 400;
        document.getElementById('capture-height').value = 450;
    }
    // 大乐透默认区域
    else {
        document.getElementById('capture-x').value = 0;
        document.getElementById('capture-y').value = 0;
        document.getElementById('capture-width').value = 400;
        document.getElementById('capture-height').value = 480;
    }

    updateSelectionBoxPosition();
    document.getElementById('dimension-display').textContent =
        `${document.getElementById('capture-width').value}px × ${document.getElementById('capture-height').value}px`;
}

// -------------------- 折叠面板 --------------------
function setupAccordions() {
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', function() {
            const accordion = this.parentElement;
            accordion.classList.toggle('active');
        });
    });
}

// -------------------- 截图保存 --------------------
async function saveScreenshots(prefix,label,count,dirHandle){
    const useFS = !!dirHandle && 'showDirectoryPicker' in window;
    stopRolling(prefix);

    const section = document.getElementById(`${prefix}-content`);
    const selectedDiv = section.querySelector(`#${prefix}-selected`);

    // 临时添加类以隐藏控制按钮
    section.classList.add('hide-controls');

    try {
        // 获取用户设置的截图区域
        const x = parseInt(document.getElementById('capture-x').value) || 0;
        const y = parseInt(document.getElementById('capture-y').value) || 0;
        const width = parseInt(document.getElementById('capture-width').value) || 400;
        const height = parseInt(document.getElementById('capture-height').value) || 200;

        for(let i=1;i<=count;i++){
            const cfg = prefix==='ssq' ? {rMax:33,rCount:6,bMax:16,bCount:1} : {rMax:35,rCount:5,bMax:12,bCount:2};
            const r = randomPick(cfg.rCount, cfg.rMax);
            const b = randomPick(cfg.bCount, cfg.bMax);
            applyPick(prefix, r, b);
            await sleep(50);

            const canvas = await html2canvas(section, {
                backgroundColor:'#ffffff', scale:2, useCORS:true,
                scrollX: -window.scrollX, scrollY: -window.scrollY,
                windowWidth: document.documentElement.scrollWidth,
                windowHeight: document.documentElement.scrollHeight
            });

            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = width * 2;
            croppedCanvas.height = height * 2;
            const ctx = croppedCanvas.getContext('2d');
            ctx.drawImage(canvas, x*2, y*2, width*2, height*2, 0, 0, width*2, height*2);

            const blob = await new Promise(res=>croppedCanvas.toBlob(res,'image/png',1));
            const stamp = new Date().toISOString().replace(/[-:TZ]/g,'').slice(0,14);
            const name = buildFileName(prefix,r,b,stamp,i);

            if(useFS){ await saveBlobToDir(dirHandle,blob,name); }else{ downloadBlob(blob,name); }
        }
    } finally {
        // 无论成功或失败都移除隐藏类
        section.classList.remove('hide-controls');
    }
}

function buildFileName(prefix, reds, blues, stamp, index){
    const rn = reds.map(n=>String(n).padStart(2,'0')).join('-');
    const bn = blues.map(n=>String(n).padStart(2,'0')).join('-');
    const tag = prefix==='ssq' ? 'SSQ' : 'DLT';
    return `${tag}_${stamp}_${rn}__${bn}_${String(index).padStart(2,'0')}.png`;
}

async function saveBlobToDir(dirHandle, blob, fileName){
    const fileHandle = await dirHandle.getFileHandle(fileName,{create:true});
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();
}

function downloadBlob(blob,fileName){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=fileName;
    document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
</script>
</body>
</html>