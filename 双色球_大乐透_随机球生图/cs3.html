<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å½©ç¥¨é€‰å·ç”Ÿæˆå™¨ - å¢å¼ºç‰ˆ</title>
<style>
    :root {
        --red-ball-color: #e91e63;
        --blue-ball-color: #2196f3;
        --red-text-color: #fff;
        --blue-text-color: #fff;
        --primary-color: #4a6cf7;
        --secondary-color: #ff4081;
        --bg-gradient-start: #f8f9fa;
        --bg-gradient-end: #e1f5fe;
        --panel-bg: #ffffff;
        --border-color: #e0e0e0;
        --text-primary: #333;
        --text-secondary: #555;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', 'Microsoft YaHei', sans-serif}
    body{background:linear-gradient(to bottom, var(--bg-gradient-start), var(--bg-gradient-end));min-height:100vh;padding:20px;color:var(--text-primary)}
    .container{max-width:1280px;margin:0 auto;background:var(--panel-bg);border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.15);overflow:hidden;display:flex;flex-direction:column}
    header{background:linear-gradient(to right, var(--primary-color), var(--secondary-color));color:#fff;padding:15px 20px;text-align:center}
    h1{font-size:28px;margin-bottom:5px;text-shadow:1px 1px 3px rgba(0,0,0,.3);letter-spacing:0.5px}
    .subtitle{font-size:14px;opacity:.9;margin-top:5px}

    /* ä¸»å†…å®¹åŒºå¸ƒå±€ */
    .main-content {display: flex; flex-direction: column; flex: 1; padding: 0 20px;}
    .content-row {display: flex; flex: 1; flex-direction: column; gap: 20px; margin-top: 15px;}

    /* å½©ç¥¨åŒº */
    .lottery-tabs-container {background: #f8f9fa; border-radius: 10px; padding: 5px; margin-bottom: 15px;}
    .tabs{display:flex; background: transparent;}
    .tab{flex:1;padding:12px;text-align:center;font-size:16px;font-weight:600;cursor:pointer;transition:.3s;border-radius:8px;}
    .tab.active{background:#fff;color:var(--primary-color);box-shadow: 0 2px 8px rgba(0,0,0,0.1)}
    .lottery-content{display:none;padding:15px;position:relative; border-radius: 12px; background: #fff; box-shadow: 0 3px 10px rgba(0,0,0,0.05);}
    .lottery-content.active{display:block}
    .section-title{text-align:center;margin:10px 0;color:var(--primary-color);font-size:18px;font-weight:600}
    .section-label{text-align:center;margin-bottom:10px;font-size:14px;color:var(--text-secondary)}
    .balls-container{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:15px}
    .ball{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:16px;cursor:pointer;transition:.2s;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .red-ball{background:#fff;color:var(--red-ball-color);border:2px solid var(--red-ball-color)}
    .red-ball.selected{background:var(--red-ball-color);color:var(--red-text-color)}
    .blue-ball{background:#fff;color:var(--blue-ball-color);border:2px solid var(--blue-ball-color)}
    .blue-ball.selected{background:var(--blue-ball-color);color:var(--blue-text-color)}
    .selected-numbers{text-align:center;padding:12px;background:#f5f5f5;border-radius:10px;margin:15px 0;font-size:16px;font-weight:bold}
    .red-number{color:var(--red-ball-color);margin:0 3px}.blue-number{color:var(--blue-ball-color);margin:0 3px}.separator{color:#777;margin:0 5px}
    footer{text-align:center;padding:15px;color:#777;font-size:13px;background:#f8f9fa;border-top:1px solid #e0e0e0; margin-top: 20px;}

    /* æˆªå›¾æ§åˆ¶åŒº */
    .capture-control-section {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin: 10px 0;
    }
    .capture-control {padding: 15px;background: #fff;border-radius: 10px;box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
    .capture-control h3 {color: var(--primary-color);margin-top: 0;margin-bottom: 15px;text-align: center; font-size: 18px;}
    .capture-control-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 15px;
    }
    .capture-control-row {display: flex;align-items: center; gap: 8px;}
    .capture-label {font-weight: 600;color: var(--text-primary); min-width: 60px; font-size: 14px;}
    .capture-input {width: 100%;padding: 8px;border: 1px solid #ddd;border-radius: 4px;text-align: center; font-size: 14px;}
    .capture-reset-btn {padding: 10px;background: #7e57c2;color: white;border: none;border-radius: 5px;cursor: pointer;font-weight: 600;width: 100%; font-size: 14px; transition: all 0.3s;}
    .capture-reset-btn:hover {background: #673ab7;}
    .preview-btn {width: 100%;padding: 10px;background: var(--primary-color);color: white;border: none;border-radius: 5px;cursor: pointer;font-weight: 600; font-size: 14px; transition: all 0.3s;}
    .preview-btn:hover {background: #3a56e6;}
    .dimension-display {text-align: center;padding: 5px;margin-top: 8px;background: #f0f0f0;border-radius: 4px;font-size: 14px;}

    /* æ§åˆ¶é¢æ¿ */
    .control-panel-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .control-panel {
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .panel-section {
        margin-bottom: 15px;
    }

    .panel-section-title {
        font-size: 16px;
        color: var(--primary-color);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e0e0e0;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .panel-section-title i {
        margin-right: 8px;
        font-size: 18px;
    }

    /* æ§åˆ¶æŒ‰é’® */
    .control-buttons {display: grid; grid-template-columns: 1fr 1fr; gap: 10px;}
    .btn{padding:12px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:.3s;box-shadow:0 3px 5px rgba(0,0,0,.1)}
    .btn-generate{background:#4caf50;color:#fff}.btn-generate:hover{background:#388e3c; transform: translateY(-2px);}
    .btn-reset{background:#f44336;color:#fff}.btn-reset:hover{background:#d32f2f; transform: translateY(-2px);}
    .btn-stop{background:#ff5722;color:#fff}.btn-stop:hover{background:#e64a19; transform: translateY(-2px);}

    .button-group {
        margin-bottom: 15px;
    }

    .button-group-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-align: center;
    }

    /* é¢œè‰²é€‰æ‹©å™¨ */
    .color-picker-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    .color-control{display:flex;flex-direction: column; gap:6px;}
    .color-label{font-weight:600; font-size: 14px; color: var(--text-secondary);}
    .color-input-container {display: flex; align-items: center; gap: 10px;}
    .color-input{width:40px;height:40px;border:none;cursor:pointer;border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1)}
    .apply-colors-btn {padding:12px;background:#7e57c2;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.3s;box-shadow:0 3px 5px rgba(0,0,0,.1)}
    .apply-colors-btn:hover{background:#673ab7; transform: translateY(-2px);}

    /* èƒŒæ™¯è®¾ç½® */
    .bg-preview{width:100%;height:100px;border-radius:10px;margin-top:10px;background-size:cover;background-position:center;border:1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05)}
    .bg-actions{display:flex;gap:10px;margin-top:10px}
    .bg-btn{padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:14px; font-weight:600; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1)}
    .bg-select{background:var(--primary-color);color:#fff}
    .bg-reset{background:#9e9e9e;color:#fff}
    .bg-select:hover{background:#3a56e6; transform: translateY(-2px);}
    .bg-reset:hover{background:#757575; transform: translateY(-2px);}

    /* æ‰¹é‡æ§åˆ¶ */
    .batch-control{display:flex;flex-direction:column;gap:10px}
    .batch-control-row{display:flex;align-items:center;gap:10px}
    .batch-control label{font-weight:600; min-width: 120px; font-size: 14px; color: var(--text-secondary)}
    .batch-control input{flex:1;padding:10px;border:1px solid #ddd;border-radius:5px;text-align:center; font-size: 14px;}
    .path-selector{display:flex;align-items:center;gap:10px}
    .path-display{padding:10px 15px;background:#fff;border:1px solid #ddd;border-radius:5px;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
    .select-path-btn{padding:10px 15px;background:var(--primary-color);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px; font-weight:600; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1)}
    .select-path-btn:hover{background:#3a56e6; transform: translateY(-2px);}
    .download-btn{padding:12px;background:#7e57c2;color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:.3s;box-shadow:0 3px 5px rgba(0,0,0,.1); margin-top: 15px;}
    .download-btn:hover{background:#673ab7; transform: translateY(-2px);}
    .status-message{margin-top:15px;padding:10px;border-radius:5px;font-size:14px;text-align:center}
    .status-success{background:#e8f5e9;color:#2e7d32}.status-error{background:#ffebee;color:#c62828}

    /* æŠ˜å é¢æ¿ */
    .accordion {border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; overflow: hidden; background: #fff;}
    .accordion-header {padding: 12px 15px; background: #f8f9fa; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 15px; font-weight: 600;}
    .accordion-icon {transition: transform 0.3s;}
    .accordion-content {padding: 15px; background: #fff; display: none;}
    .accordion.active .accordion-content {display: block;}
    .accordion.active .accordion-icon {transform: rotate(180deg);}

    /* é€‰æ‹©æ¡† */
    .selection-box {position: absolute;border: 2px dashed var(--secondary-color);background: rgba(255, 64, 129, 0.1);z-index: 100;cursor: move;}
    .selection-box:hover {border-color: #ff5252;}
    .resize-handle {position: absolute;width: 12px;height: 12px;background: var(--secondary-color);border-radius: 50%;}
    .resize-nw {top: -6px;left: -6px;cursor: nw-resize;}
    .resize-ne {top: -6px;right: -6px;cursor: ne-resize;}
    .resize-sw {bottom: -6px;left: -6px;cursor: sw-resize;}
    .resize-se {bottom: -6px;right: -6px;cursor: se-resize;}

    /* å“åº”å¼è®¾è®¡ */
    @media (min-width: 1024px) {
        .content-row {
            flex-direction: row;
        }

        .lottery-area {
            flex: 3;
        }

        .control-panel-container {
            flex: 2;
        }
    }

    @media (max-width: 1023px) {
        .control-buttons {
            grid-template-columns: 1fr;
        }

        .color-picker-grid {
            grid-template-columns: 1fr;
        }

        .capture-control-grid {
            grid-template-columns: 1fr;
        }
    }

    /* å›¾æ ‡æ ·å¼ */
    .icon {
        margin-right: 8px;
        font-size: 18px;
    }
</style>
</head>
<body>
<div class="container" id="capture-root">
    <header>
        <h1>å½©ç¥¨é€‰å·ç”Ÿæˆå™¨ - ä¸“ä¸šç‰ˆ</h1>
        <p class="subtitle">éšæœºç”ŸæˆåŒè‰²çƒå’Œå¤§ä¹é€å·ç  | å¢å¼ºæˆªå›¾åŠŸèƒ½</p>
    </header>

    <div class="main-content">
        <div class="content-row">
            <div class="lottery-area">
                <div class="lottery-tabs-container">
                    <div class="tabs">
                        <div class="tab active" data-target="ssq">åŒè‰²çƒé€‰å·å™¨</div>
                        <div class="tab" data-target="dlt">å¤§ä¹é€é€‰å·å™¨</div>
                    </div>
                </div>

                <!-- åŒè‰²çƒ -->
                <section class="lottery-content active" id="ssq-content">
                    <div class="section-title">åŒè‰²çƒé€‰å·å™¨</div>
                    <div class="section-label">çº¢çƒåŒºï¼ˆé€‰æ‹©6ä¸ªï¼‰</div>
                    <div class="balls-container" id="ssq-red-balls"></div>
                    <div class="section-label">è“çƒåŒºï¼ˆé€‰æ‹©1ä¸ªï¼‰</div>
                    <div class="balls-container" id="ssq-blue-balls"></div>

                    <div class="selected-numbers" id="ssq-selected">
                        é€‰ä¸­çš„å·ç ï¼š<span class="red-number">2</span> <span class="red-number">8</span> <span class="red-number">13</span> <span class="red-number">16</span> <span class="red-number">21</span> <span class="red-number">23</span> <span class="separator">â†’</span> <span class="blue-number">12</span>
                    </div>

                    <div class="capture-control-section">
                        <div class="capture-control">
                            <h3>æˆªå›¾åŒºåŸŸè®¾ç½®</h3>
                            <div class="capture-control-grid">
                                <div class="capture-control-row">
                                    <span class="capture-label">X:</span>
                                    <input type="number" class="capture-input" id="capture-x" min="0" value="0">
                                </div>
                                <div class="capture-control-row">
                                    <span class="capture-label">Y:</span>
                                    <input type="number" class="capture-input" id="capture-y" min="0" value="0">
                                </div>
                                <div class="capture-control-row">
                                    <span class="capture-label">å®½åº¦:</span>
                                    <input type="number" class="capture-input" id="capture-width" min="50" value="400">
                                </div>
                                <div class="capture-control-row">
                                    <span class="capture-label">é«˜åº¦:</span>
                                    <input type="number" class="capture-input" id="capture-height" min="50" value="200">
                                </div>
                            </div>
                            <div class="dimension-display" id="dimension-display">400px Ã— 200px</div>
                            <button class="capture-reset-btn" id="capture-reset">é‡ç½®æˆªå›¾åŒºåŸŸ</button>
                            <button class="preview-btn" id="preview-capture">é¢„è§ˆæˆªå›¾åŒºåŸŸ</button>
                        </div>
                    </div>

                    <footer>
                        <p>Â© 2023 å½©ç¥¨é€‰å·ç”Ÿæˆå™¨ | æœ¬å·¥å…·ä»…ä¾›å¨±ä¹å‚è€ƒ | æˆªå›¾åŒºåŸŸå¯è‡ªç”±è°ƒæ•´</p>
                    </footer>
                </section>

                <!-- å¤§ä¹é€ -->
                <section class="lottery-content" id="dlt-content">
                    <div class="section-title">å¤§ä¹é€é€‰å·å™¨</div>

                    <div class="section-label">å‰åŒºçº¢çƒï¼ˆé€‰æ‹©5ä¸ªï¼‰</div>
                    <div class="balls-container" id="dlt-red-balls"></div>

                    <div class="section-label">ååŒºè“çƒï¼ˆé€‰æ‹©2ä¸ªï¼‰</div>
                    <div class="balls-container" id="dlt-blue-balls"></div>

                    <div class="selected-numbers" id="dlt-selected">
                        é€‰ä¸­çš„å·ç ï¼š<span class="red-number">3</span> <span class="red-number">11</span> <span class="red-number">13</span> <span class="red-number">22</span> <span class="red-number">31</span> <span class="blue-number">2</span> <span class="blue-number">8</span>
                    </div>

                    <div class="capture-control-section">
                        <div class="capture-control">
                            <h3>æˆªå›¾åŒºåŸŸè®¾ç½®</h3>
                            <div class="capture-control-grid">
                                <div class="capture-control-row">
                                    <span class="capture-label">X:</span>
                                    <input type="number" class="capture-input" id="capture-x" min="0" value="0">
                                </div>
                                <div class="capture-control-row">
                                    <span class="capture-label">Y:</span>
                                    <input type="number" class="capture-input" id="capture-y" min="0" value="0">
                                </div>
                                <div class="capture-control-row">
                                    <span class="capture-label">å®½åº¦:</span>
                                    <input type="number" class="capture-input" id="capture-width" min="50" value="400">
                                </div>
                                <div class="capture-control-row">
                                    <span class="capture-label">é«˜åº¦:</span>
                                    <input type="number" class="capture-input" id="capture-height" min="50" value="200">
                                </div>
                            </div>
                            <div class="dimension-display" id="dimension-display">400px Ã— 200px</div>
                            <button class="capture-reset-btn" id="capture-reset">é‡ç½®æˆªå›¾åŒºåŸŸ</button>
                            <button class="preview-btn" id="preview-capture">é¢„è§ˆæˆªå›¾åŒºåŸŸ</button>
                        </div>
                    </div>

                    <footer>
                        <p>Â© 2023 å½©ç¥¨é€‰å·ç”Ÿæˆå™¨ | æœ¬å·¥å…·ä»…ä¾›å¨±ä¹å‚è€ƒ | æˆªå›¾åŒºåŸŸå¯è‡ªç”±è°ƒæ•´</p>
                    </footer>
                </section>
            </div>

            <div class="control-panel-container">
                <div class="control-panel">
                    <div class="panel-section">
                        <div class="panel-section-title">
                            <span class="icon">ğŸ²</span> æ“ä½œæ§åˆ¶
                        </div>
                        <div class="button-group">
                            <div class="button-group-title">åŒè‰²çƒ</div>
                            <div class="control-buttons">
                                <button class="btn btn-generate" id="ssq-generate">å¼€å§‹é€‰å·</button>
                                <button class="btn btn-stop" id="ssq-stop">åœæ­¢</button>
                                <button class="btn btn-reset" id="ssq-reset">é‡ç½®</button>
                                <button class="btn btn-generate" id="ssq-download">ç”Ÿæˆå›¾ç‰‡</button>
                            </div>
                        </div>

                        <div class="button-group">
                            <div class="button-group-title">å¤§ä¹é€</div>
                            <div class="control-buttons">
                                <button class="btn btn-generate" id="dlt-generate">å¼€å§‹é€‰å·</button>
                                <button class="btn btn-stop" id="dlt-stop">åœæ­¢</button>
                                <button class="btn btn-reset" id="dlt-reset">é‡ç½®</button>
                                <button class="btn btn-generate" id="dlt-download">ç”Ÿæˆå›¾ç‰‡</button>
                            </div>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header">é¢œè‰²è®¾ç½®
                            <span class="accordion-icon">â–¼</span>
                        </div>
                        <div class="accordion-content">
                            <div class="color-picker-grid">
                                <div class="color-control">
                                    <span class="color-label">çº¢çƒé¢œè‰²</span>
                                    <div class="color-input-container">
                                        <input type="color" class="color-input" id="red-ball-color" value="#e91e63">
                                        <span>èƒŒæ™¯</span>
                                    </div>
                                </div>
                                <div class="color-control">
                                    <span class="color-label">çº¢çƒæ•°å­—</span>
                                    <div class="color-input-container">
                                        <input type="color" class="color-input" id="red-text-color" value="#ffffff">
                                        <span>æ•°å­—</span>
                                    </div>
                                </div>
                                <div class="color-control">
                                    <span class="color-label">è“çƒé¢œè‰²</span>
                                    <div class="color-input-container">
                                        <input type="color" class="color-input" id="blue-ball-color" value="#2196f3">
                                        <span>èƒŒæ™¯</span>
                                    </div>
                                </div>
                                <div class="color-control">
                                    <span class="color-label">è“çƒæ•°å­—</span>
                                    <div class="color-input-container">
                                        <input type="color" class="color-input" id="blue-text-color" value="#ffffff">
                                        <span>æ•°å­—</span>
                                    </div>
                                </div>
                                <button class="apply-colors-btn" id="apply-colors">åº”ç”¨é¢œè‰²è®¾ç½®</button>
                            </div>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header">èƒŒæ™¯è®¾ç½®
                            <span class="accordion-icon">â–¼</span>
                        </div>
                        <div class="accordion-content">
                            <div class="bg-preview" id="bg-preview"></div>
                            <div class="bg-actions">
                                <button class="bg-btn bg-select" id="select-bg">é€‰æ‹©èƒŒæ™¯å›¾</button>
                                <button class="bg-btn bg-reset" id="reset-bg">æ¢å¤é»˜è®¤</button>
                            </div>
                            <input type="file" id="bg-file" accept="image/*" style="display:none">
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header">æ‰¹é‡è®¾ç½®
                            <span class="accordion-icon">â–¼</span>
                        </div>
                        <div class="accordion-content">
                            <div class="batch-control">
                                <div class="batch-control-row">
                                    <label>ç”Ÿæˆå›¾ç‰‡æ•°é‡:</label>
                                    <input type="number" id="ssq-count" min="1" max="100" value="5">
                                </div>
                                <div class="path-selector">
                                    <div class="path-display" id="ssq-path-display">æœªé€‰æ‹©ä¿å­˜è·¯å¾„</div>
                                    <button class="select-path-btn" id="ssq-select-path">é€‰æ‹©è·¯å¾„</button>
                                </div>

                                <div class="batch-control-row" style="margin-top: 15px;">
                                    <label>ç”Ÿæˆå›¾ç‰‡æ•°é‡:</label>
                                    <input type="number" id="dlt-count" min="1" max="100" value="5">
                                </div>
                                <div class="path-selector">
                                    <div class="path-display" id="dlt-path-display">æœªé€‰æ‹©ä¿å­˜è·¯å¾„</div>
                                    <button class="select-path-btn" id="dlt-select-path">é€‰æ‹©è·¯å¾„</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// -------------------- åˆå§‹åŒ– --------------------
document.addEventListener('DOMContentLoaded', () => {
    initBalls('ssq-red-balls', 33, 'red');
    initBalls('ssq-blue-balls', 16, 'blue');
    initBalls('dlt-red-balls', 35, 'red');
    initBalls('dlt-blue-balls', 12, 'blue');
    setDefaultSelection();
    setupTabs();
    setupPathSelectors();
    setupButtonEvents();
    setupColorPicker();
    setupBackgroundControl();
    setupCaptureControl();
    setupAccordions();
});

// -------------------- å…¨å±€çŠ¶æ€ --------------------
let dirHandleSSQ = null;
let dirHandleDLT = null;
const timers = { ssq: null, dlt: null };
const lastPick = { ssq: { red: [], blue: [] }, dlt: { red: [], blue: [] } };
let selectionBox = null;
let currentLottery = 'ssq'; // å½“å‰é€‰ä¸­çš„å½©ç¥¨ç±»å‹

// -------------------- UI --------------------
function initBalls(containerId, count, type){
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    for(let i=1;i<=count;i++){
        const el = document.createElement('div');
        el.className = `ball ${type}-ball`;
        el.textContent = i;
        el.dataset.number = i;
        el.addEventListener('click', function(){
            this.classList.toggle('selected');
            updateSelectedNumbers();
        });
        container.appendChild(el);
    }
}

function setDefaultSelection(){
    selectBalls('ssq-red-balls', [2,8,13,16,21,23]);
    selectBalls('ssq-blue-balls', [12]);
    selectBalls('dlt-red-balls', [3,11,13,22,31]);
    selectBalls('dlt-blue-balls', [2,8]);
}

function selectBalls(containerId, numbers){
    const container = document.getElementById(containerId);
    const balls = container.querySelectorAll('.ball');
    balls.forEach(b=>{
        const n = +b.dataset.number;
        if(numbers.includes(n)) b.classList.add('selected');
    });
    updateSelectedNumbers();
}

function resetSelection(containerId){
    const container = document.getElementById(containerId);
    container.querySelectorAll('.ball.selected').forEach(b=>b.classList.remove('selected'));
}

function updateSelectedNumbers(){
    const ssqR = getSelected('#ssq-red-balls');
    const ssqB = getSelected('#ssq-blue-balls');
    document.getElementById('ssq-selected').innerHTML =
        `é€‰ä¸­çš„å·ç ï¼š${ssqR.map(n=>`<span class="red-number">${n}</span>`).join(' ')} <span class="separator">â†’</span> ${ssqB.map(n=>`<span class="blue-number">${n}</span>`).join(' ')}`;

    const dltR = getSelected('#dlt-red-balls');
    const dltB = getSelected('#dlt-blue-balls');
    document.getElementById('dlt-selected').innerHTML =
        `é€‰ä¸­çš„å·ç ï¼š${dltR.map(n=>`<span class="red-number">${n}</span>`).join(' ')} ${dltB.map(n=>`<span class="blue-number">${n}</span>`).join(' ')}`;

    lastPick.ssq = { red: ssqR, blue: ssqB };
    lastPick.dlt = { red: dltR,  blue: dltB  };
}

function getSelected(selector){
    return Array.from(document.querySelectorAll(`${selector} .ball.selected`))
      .map(b=>+b.dataset.number).sort((a,b)=>a-b);
}

// -------------------- éšæœºé€‰å· --------------------
function randomPick(count, max){
    const set = new Set();
    while(set.size < count) set.add(Math.floor(Math.random()*max)+1);
    return [...set].sort((a,b)=>a-b);
}

function applyPick(prefix, redNums, blueNums){
    resetSelection(`${prefix}-red-balls`);
    resetSelection(`${prefix}-blue-balls`);

    const redEls = document.getElementById(`${prefix}-red-balls`).querySelectorAll('.ball');
    redNums.forEach(n=>redEls[n-1]?.classList.add('selected'));
    const blueEls = document.getElementById(`${prefix}-blue-balls`).querySelectorAll('.ball');
    blueNums.forEach(n=>blueEls[n-1]?.classList.add('selected'));

    updateSelectedNumbers();
}

function startRolling(prefix){
    stopRolling(prefix);
    const cfg = prefix==='ssq' ? {rMax:33, rCount:6, bMax:16, bCount:1} : {rMax:35, rCount:5, bMax:12, bCount:2};
    timers[prefix] = setInterval(()=>{
        const r = randomPick(cfg.rCount, cfg.rMax);
        const b = randomPick(cfg.bCount, cfg.bMax);
        applyPick(prefix, r, b);
    },120);
}

function stopRolling(prefix){
    if(timers[prefix]) { clearInterval(timers[prefix]); timers[prefix]=null; }
}

// -------------------- é€‰é¡¹å¡ --------------------
function setupTabs(){
    document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click', function(){
            const target = this.dataset.target;
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.lottery-content').forEach(c=>c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(`${target}-content`).classList.add('active');
            currentLottery = target; // æ›´æ–°å½“å‰å½©ç¥¨ç±»å‹
            // æ›´æ–°æˆªå›¾åŒºåŸŸé¢„è§ˆæ¡†ä½ç½®
            updateSelectionBoxPosition();
        });
    });
}

// -------------------- è·¯å¾„é€‰æ‹© --------------------
function setupPathSelectors(){
    document.getElementById('ssq-select-path').addEventListener('click', async ()=>{
        const handle = await pickDirectory();
        if(handle){ dirHandleSSQ = handle; document.getElementById('ssq-path-display').textContent = handle.name; }
    });
    document.getElementById('dlt-select-path').addEventListener('click', async ()=>{
        const handle = await pickDirectory();
        if(handle){ dirHandleDLT = handle; document.getElementById('dlt-path-display').textContent = handle.name; }
    });
}

async function pickDirectory(){
    if('showDirectoryPicker' in window){
        try{
            const dir = await window.showDirectoryPicker();
            const ok = await requestRW(dir);
            return ok ? dir : null;
        }catch(e){ console.warn(e); return null; }
    }else{ alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›®å½•é€‰æ‹©ï¼Œå°†ä½¿ç”¨æµè§ˆå™¨ä¸‹è½½æ–¹å¼ä¿å­˜ã€‚'); return null; }
}
async function requestRW(handle){
    if(!handle || !handle.requestPermission) return true;
    const opts = { mode:'readwrite' };
    const cur = await handle.queryPermission?.(opts);
    if(cur === 'granted') return true;
    const res = await handle.requestPermission?.(opts);
    return res === 'granted';
}

// -------------------- æŒ‰é’®äº‹ä»¶ --------------------
function setupButtonEvents(){
    document.getElementById('ssq-generate').addEventListener('click', ()=>startRolling('ssq'));
    document.getElementById('ssq-stop').addEventListener('click', ()=>stopRolling('ssq'));
    document.getElementById('dlt-generate').addEventListener('click', ()=>startRolling('dlt'));
    document.getElementById('dlt-stop').addEventListener('click', ()=>stopRolling('dlt'));

    document.getElementById('ssq-reset').addEventListener('click', ()=>{
        resetSelection('ssq-red-balls');
        resetSelection('ssq-blue-balls');
        updateSelectedNumbers();
    });

    document.getElementById('dlt-reset').addEventListener('click', ()=>{
        resetSelection('dlt-red-balls');
        resetSelection('dlt-blue-balls');
        updateSelectedNumbers();
    });

    document.getElementById('ssq-download').addEventListener('click', async ()=>{
        const n = +document.getElementById('ssq-count').value || 1;
        await saveScreenshots('ssq','åŒè‰²çƒ', n, dirHandleSSQ);
    });
    document.getElementById('dlt-download').addEventListener('click', async ()=>{
        const n = +document.getElementById('dlt-count').value || 1;
        await saveScreenshots('dlt','å¤§ä¹é€', n, dirHandleDLT);
    });
}

// -------------------- é¢œè‰²é€‰æ‹©å™¨ --------------------
function setupColorPicker(){
    const redBallColorInput = document.getElementById('red-ball-color');
    const blueBallColorInput = document.getElementById('blue-ball-color');
    const redTextColorInput = document.getElementById('red-text-color');
    const blueTextColorInput = document.getElementById('blue-text-color');
    const applyButton = document.getElementById('apply-colors');

    // è®¾ç½®åˆå§‹å€¼
    redBallColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--red-ball-color').trim();
    blueBallColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--blue-ball-color').trim();
    redTextColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--red-text-color').trim();
    blueTextColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--blue-text-color').trim();

    applyButton.addEventListener('click', () => {
        document.documentElement.style.setProperty('--red-ball-color', redBallColorInput.value);
        document.documentElement.style.setProperty('--blue-ball-color', blueBallColorInput.value);
        document.documentElement.style.setProperty('--red-text-color', redTextColorInput.value);
        document.documentElement.style.setProperty('--blue-text-color', blueTextColorInput.value);
    });
}

// -------------------- èƒŒæ™¯æ§åˆ¶ --------------------
function setupBackgroundControl(){
    const bgFileInput = document.getElementById('bg-file');
    const bgPreview = document.getElementById('bg-preview');
    const selectButton = document.getElementById('select-bg');
    const resetButton = document.getElementById('reset-bg');

    selectButton.addEventListener('click', () => {
        bgFileInput.click();
    });

    resetButton.addEventListener('click', () => {
        document.body.style.background = 'linear-gradient(to bottom, var(--bg-gradient-start), var(--bg-gradient-end))';
        bgPreview.style.background = '';
    });

    bgFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !file.type.match('image.*')) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const imageUrl = e.target.result;
            document.body.style.background = `url(${imageUrl}) center/cover fixed`;
            bgPreview.style.background = `url(${imageUrl}) center/cover`;
        };
        reader.readAsDataURL(file);
    });
}

// -------------------- æˆªå›¾åŒºåŸŸæ§åˆ¶ --------------------
function setupCaptureControl() {
    // åˆ›å»ºé€‰æ‹©æ¡†
    createSelectionBox();

    // é‡ç½®æŒ‰é’®
    document.getElementById('capture-reset').addEventListener('click', resetCaptureArea);

    // é¢„è§ˆæŒ‰é’®
    document.getElementById('preview-capture').addEventListener('click', previewCaptureArea);

    // è¾“å…¥æ¡†å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆæ¡†
    ['capture-x', 'capture-y', 'capture-width', 'capture-height'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateSelectionBoxPosition);
    });
}

function createSelectionBox() {
    selectionBox = document.createElement('div');
    selectionBox.className = 'selection-box';
    selectionBox.style.display = 'none';

    // åˆ›å»ºè°ƒæ•´å¤§å°çš„æ‰‹æŸ„
    const handles = ['nw', 'ne', 'sw', 'se'];
    handles.forEach(pos => {
        const handle = document.createElement('div');
        handle.className = `resize-handle resize-${pos}`;
        handle.dataset.pos = pos;
        selectionBox.appendChild(handle);
    });

    document.body.appendChild(selectionBox);

    // æ·»åŠ æ‹–æ‹½äº‹ä»¶
    let isDragging = false;
    let startX, startY;
    let startLeft, startTop;
    let currentHandle = null;

    selectionBox.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resize-handle')) {
            // è°ƒæ•´å¤§å°
            currentHandle = e.target.dataset.pos;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(selectionBox.style.left);
            startTop = parseInt(selectionBox.style.top);
            const startWidth = parseInt(selectionBox.style.width);
            const startHeight = parseInt(selectionBox.style.height);

            function resize(e) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                if (currentHandle === 'nw') {
                    selectionBox.style.left = (startLeft + dx) + 'px';
                    selectionBox.style.top = (startTop + dy) + 'px';
                    selectionBox.style.width = (startWidth - dx) + 'px';
                    selectionBox.style.height = (startHeight - dy) + 'px';
                } else if (currentHandle === 'ne') {
                    selectionBox.style.top = (startTop + dy) + 'px';
                    selectionBox.style.width = (startWidth + dx) + 'px';
                    selectionBox.style.height = (startHeight - dy) + 'px';
                } else if (currentHandle === 'sw') {
                    selectionBox.style.left = (startLeft + dx) + 'px';
                    selectionBox.style.width = (startWidth - dx) + 'px';
                    selectionBox.style.height = (startHeight + dy) + 'px';
                } else if (currentHandle === 'se') {
                    selectionBox.style.width = (startWidth + dx) + 'px';
                    selectionBox.style.height = (startHeight + dy) + 'px';
                }

                updateInputsFromBox();
            }

            function stopResize() {
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }

            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        } else {
            // ç§»åŠ¨æ•´ä¸ªé€‰æ‹©æ¡†
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(selectionBox.style.left);
            startTop = parseInt(selectionBox.style.top);

            function move(e) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                selectionBox.style.left = (startLeft + dx) + 'px';
                selectionBox.style.top = (startTop + dy) + 'px';
                updateInputsFromBox();
            }

            function stopMove() {
                document.removeEventListener('mousemove', move);
                document.removeEventListener('mouseup', stopMove);
                isDragging = false;
            }

            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', stopMove);
        }
    });
}

function previewCaptureArea() {
    const content = document.getElementById(`${currentLottery}-content`);
    const rect = content.getBoundingClientRect();

    const x = parseInt(document.getElementById('capture-x').value) || 0;
    const y = parseInt(document.getElementById('capture-y').value) || 0;
    const width = parseInt(document.getElementById('capture-width').value) || 400;
    const height = parseInt(document.getElementById('capture-height').value) || 200;

    // ç¡®ä¿é€‰æ‹©æ¡†åœ¨å¯è§åŒºåŸŸå†…
    const maxX = rect.width - width;
    const maxY = rect.height - height;
    const clampedX = Math.max(0, Math.min(x, maxX));
    const clampedY = Math.max(0, Math.min(y, maxY));

    selectionBox.style.display = 'block';
    selectionBox.style.left = (rect.left + clampedX) + 'px';
    selectionBox.style.top = (rect.top + clampedY) + 'px';
    selectionBox.style.width = width + 'px';
    selectionBox.style.height = height + 'px';

    // æ›´æ–°è¾“å…¥æ¡†çš„å€¼
    document.getElementById('capture-x').value = clampedX;
    document.getElementById('capture-y').value = clampedY;
    document.getElementById('capture-width').value = width;
    document.getElementById('capture-height').value = height;
    document.getElementById('dimension-display').textContent = `${width}px Ã— ${height}px`;
}

function updateSelectionBoxPosition() {
    if (!selectionBox || selectionBox.style.display !== 'block') return;

    const content = document.getElementById(`${currentLottery}-content`);
    const rect = content.getBoundingClientRect();

    const x = parseInt(document.getElementById('capture-x').value) || 0;
    const y = parseInt(document.getElementById('capture-y').value) || 0;
    const width = parseInt(document.getElementById('capture-width').value) || 400;
    const height = parseInt(document.getElementById('capture-height').value) || 200;

    // ç¡®ä¿é€‰æ‹©æ¡†åœ¨å¯è§åŒºåŸŸå†…
    const maxX = rect.width - width;
    const maxY = rect.height - height;
    const clampedX = Math.max(0, Math.min(x, maxX));
    const clampedY = Math.max(0, Math.min(y, maxY));

    selectionBox.style.left = (rect.left + clampedX) + 'px';
    selectionBox.style.top = (rect.top + clampedY) + 'px';
    selectionBox.style.width = width + 'px';
    selectionBox.style.height = height + 'px';

    // æ›´æ–°è¾“å…¥æ¡†çš„å€¼
    document.getElementById('capture-x').value = clampedX;
    document.getElementById('capture-y').value = clampedY;
    document.getElementById('capture-width').value = width;
    document.getElementById('capture-height').value = height;
    document.getElementById('dimension-display').textContent = `${width}px Ã— ${height}px`;
}

function updateInputsFromBox() {
    const content = document.getElementById(`${currentLottery}-content`);
    const contentRect = content.getBoundingClientRect();
    const boxRect = selectionBox.getBoundingClientRect();

    const x = boxRect.left - contentRect.left;
    const y = boxRect.top - contentRect.top;
    const width = boxRect.width;
    const height = boxRect.height;

    document.getElementById('capture-x').value = Math.max(0, Math.round(x));
    document.getElementById('capture-y').value = Math.max(0, Math.round(y));
    document.getElementById('capture-width').value = Math.max(50, Math.round(width));
    document.getElementById('capture-height').value = Math.max(50, Math.round(height));
    document.getElementById('dimension-display').textContent = `${Math.round(width)}px Ã— ${Math.round(height)}px`;
}

function resetCaptureArea() {
    // åŒè‰²çƒé»˜è®¤åŒºåŸŸ
    if (currentLottery === 'ssq') {
        document.getElementById('capture-x').value = 0;
        document.getElementById('capture-y').value = 0;
        document.getElementById('capture-width').value = 400;
        document.getElementById('capture-height').value = 450;
    }
    // å¤§ä¹é€é»˜è®¤åŒºåŸŸ
    else {
        document.getElementById('capture-x').value = 0;
        document.getElementById('capture-y').value = 0;
        document.getElementById('capture-width').value = 400;
        document.getElementById('capture-height').value = 480;
    }

    updateSelectionBoxPosition();
    document.getElementById('dimension-display').textContent =
        `${document.getElementById('capture-width').value}px Ã— ${document.getElementById('capture-height').value}px`;
}

// -------------------- æŠ˜å é¢æ¿ --------------------
function setupAccordions() {
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', function() {
            const accordion = this.parentElement;
            accordion.classList.toggle('active');
        });
    });
}

// -------------------- æˆªå›¾ä¿å­˜ --------------------
async function saveScreenshots(prefix,label,count,dirHandle){
    const useFS = !!dirHandle && 'showDirectoryPicker' in window;
    stopRolling(prefix);

    const section = document.getElementById(`${prefix}-content`);
    const selectedDiv = section.querySelector(`#${prefix}-selected`);

    // ä¸´æ—¶æ·»åŠ ç±»ä»¥éšè—æ§åˆ¶æŒ‰é’®
    section.classList.add('hide-controls');

    try {
        // è·å–ç”¨æˆ·è®¾ç½®çš„æˆªå›¾åŒºåŸŸ
        const x = parseInt(document.getElementById('capture-x').value) || 0;
        const y = parseInt(document.getElementById('capture-y').value) || 0;
        const width = parseInt(document.getElementById('capture-width').value) || 400;
        const height = parseInt(document.getElementById('capture-height').value) || 200;

        for(let i=1;i<=count;i++){
            const cfg = prefix==='ssq' ? {rMax:33,rCount:6,bMax:16,bCount:1} : {rMax:35,rCount:5,bMax:12,bCount:2};
            const r = randomPick(cfg.rCount, cfg.rMax);
            const b = randomPick(cfg.bCount, cfg.bMax);
            applyPick(prefix, r, b);
            await sleep(50);

            const canvas = await html2canvas(section, {
                backgroundColor:'#ffffff', scale:2, useCORS:true,
                scrollX: -window.scrollX, scrollY: -window.scrollY,
                windowWidth: document.documentElement.scrollWidth,
                windowHeight: document.documentElement.scrollHeight
            });

            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = width * 2;
            croppedCanvas.height = height * 2;
            const ctx = croppedCanvas.getContext('2d');
            ctx.drawImage(canvas, x*2, y*2, width*2, height*2, 0, 0, width*2, height*2);

            const blob = await new Promise(res=>croppedCanvas.toBlob(res,'image/png',1));
            const stamp = new Date().toISOString().replace(/[-:TZ]/g,'').slice(0,14);
            const name = buildFileName(prefix,r,b,stamp,i);

            if(useFS){ await saveBlobToDir(dirHandle,blob,name); }else{ downloadBlob(blob,name); }
        }
    } finally {
        // æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ç§»é™¤éšè—ç±»
        section.classList.remove('hide-controls');
    }
}

function buildFileName(prefix, reds, blues, stamp, index){
    const rn = reds.map(n=>String(n).padStart(2,'0')).join('-');
    const bn = blues.map(n=>String(n).padStart(2,'0')).join('-');
    const tag = prefix==='ssq' ? 'SSQ' : 'DLT';
    return `${tag}_${stamp}_${rn}__${bn}_${String(index).padStart(2,'0')}.png`;
}

async function saveBlobToDir(dirHandle, blob, fileName){
    const fileHandle = await dirHandle.getFileHandle(fileName,{create:true});
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();
}

function downloadBlob(blob,fileName){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=fileName;
    document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
</script>
</body>
</html>